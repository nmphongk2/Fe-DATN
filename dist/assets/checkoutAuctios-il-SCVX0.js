import{f as v,h as f,g as S,r as w,ba as T,j as t,D as j,bb as N,E as M,bc as P}from"./index-B8WTsAS6.js";import{C as k}from"./Card-Df5Z5bdj.js";import{Q as C,B as m}from"./react-toastify.esm-BnAFxftJ.js";import{u as A,C as E}from"./index.esm-CH-ucXk-.js";import"./clsx-B-dksMZM.js";class I{constructor(n){this.signatureService=n}checkSystemTime(){const n=new Date().getTime(),o=Date.now();Math.abs(n-o)>1e3&&console.warn("System time might be out of sync with real time.")}generateUniqueId(){return"MOMO"+new Date().getTime()+Math.floor(Math.random()*1e4)}async processMoMoPayment(n,o){this.checkSystemTime();const e="MOMO",a="F8BBA842ECF85",s="K951B6PE1waDMi640xX08PD3vg6EkVlz",c=this.generateUniqueId(),l=c,d=`Thanh toán đấu giá ${o}`,y="http://localhost:3150/confimAucDefault",p="http://localhost:3150/confimAucDefault",x="",g="captureWallet",b=`accessKey=${a}&amount=${n}&extraData=${x}&ipnUrl=${p}&orderId=${l}&orderInfo=${d}&partnerCode=${e}&redirectUrl=${y}&requestId=${c}&requestType=${g}`,r=await this.signatureService.calculateSignature(b,s),i=JSON.stringify({partnerCode:e,accessKey:a,requestId:c,amount:n,orderId:l,orderInfo:d,redirectUrl:y,ipnUrl:p,extraData:x,requestType:g,signature:r,lang:"en"});return this.execPostRequest("https://proxy.cors.sh/https://test-payment.momo.vn/v2/gateway/api/create",i)}async execPostRequest(n,o){try{const e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","Content-Length":o.length.toString(),"x-cors-api-key":"temp_1f7c5cc4e0bf72ae8aae7281de4c2e3e"},body:o});if(e.ok)return await e.json();{const a=await e.text();throw console.error(`HTTP error! Status: ${e.status}, Message: ${a}`),new Error(`HTTP error! Status: ${e.status}, Message: ${a}`)}}catch(e){throw console.error("Error in execPostRequest:",e),e}}async processMoMoPaymentWithRetry(n,o){let a=0;for(;a<5;)try{const s=await this.processMoMoPayment(n,o);if(s&&s.payUrl){const c=new Date().getTime(),l=c+10*60*1e3;localStorage.setItem("paymentCreationTime",c.toString()),localStorage.setItem("paymentExpirationTime",l.toString());const d=s.payUrl;return window.location.href=s.payUrl,d}else console.error("Invalid payment result:",s)}catch(s){if(s instanceof Error)if(s.status===429){const c=Math.pow(2,a)*1e3;console.log(`Retrying in ${c} milliseconds...`),await new Promise(l=>setTimeout(l,c)),a++}else throw console.error("Error during payment:",s.message),s;else throw console.error("Unknown error during payment"),s}console.error("Exceeded maximum retries. Payment failed.")}}const $=async(u,n)=>{const o=new TextEncoder,e=o.encode(u),a=await crypto.subtle.importKey("raw",o.encode(n),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),s=await crypto.subtle.sign("HMAC",a,e);return Array.from(new Uint8Array(s)).map(d=>d.toString(16).padStart(2,"0")).join("")},U={calculateSignature:$},R=new I(U),q=()=>{const u=v(),n=f(r=>{var i;return(i=r.auth.profile.profile)==null?void 0:i._id}),o=f(r=>{var i;return(i=r.bidding.bidData)==null?void 0:i.data.product_bidding.productId}),e=f(r=>r.auctCheckout.auctionData),a=f(r=>r.orderAuction.loading),s=S(),{control:c,handleSubmit:l}=A(),[d,y]=w.useState(0);w.useEffect(()=>{n&&o&&u(T(o))},[u,o]),w.useEffect(()=>{if(e){const i=(e.auctionTotal||0)+31e3;y(i)}},[e]);const p=e==null?void 0:e.auctionId,x=async r=>{if(!(e!=null&&e.userAddress)||!(e!=null&&e.userName)||!(e!=null&&e.userSdt)){s("/profile"),m.error("Bạn cần cập nhật thông tin cá nhân và địa chỉ");return}if(!p||!n||!r.payment){m.error("Vui lòng điền đầy đủ thông tin và chọn phương thức thanh toán");return}const i={userId:n,auctionDetails:p,payment:r.payment};try{const h=await u(P(i)).unwrap();if(r.payment==="MoMo")await R.processMoMoPaymentWithRetry(d,e.auctionId),m.success("Thanh toán thành công");else if(r.payment==="Cash")h.data&&(m.success("Thanh toán khi nhận hàng"),s("/confimAucDefault"));else if(r.payment==="VnPay")if(h.data&&h.data.hashLinkPayment)m.success("Thanh toán thành công"),window.location.href=h.data.hashLinkPayment;else throw new Error("VNPay payment URL is missing in the response");else throw new Error("Phương thức thanh toán không hợp lệ")}catch(h){console.error("Error processing order:",h),m.error("Đã xảy ra lỗi trong quá trình xử lý đơn hàng")}},g=31e3,b=e&&e.auctionTotal!==void 0?e.auctionTotal+g:g;return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"container py-4 flex items-center gap-3",children:[t.jsx("a",{href:"/",className:"text-primary text-base",children:t.jsx("i",{className:"fa-solid fa-house"})}),t.jsx("span",{className:"text-sm text-gray-400",children:t.jsx("i",{className:"fa-solid fa-chevron-right"})}),t.jsx("p",{className:"text-gray-600 font-medium",children:"Checkout"})]}),t.jsxs("div",{className:"container grid grid-cols-12 items-start pb-16 pt-4 gap-6",children:[t.jsxs("div",{className:"col-span-8 border border-gray-200 p-4 rounded-lg",children:[t.jsx("h3",{className:"text-lg font-medium capitalize mb-4",children:"Checkout"}),t.jsx("div",{className:"space-y-4",children:t.jsxs("form",{onSubmit:l(x),children:[t.jsxs("div",{children:[t.jsx(j,{htmlFor:"name",value:"Tên người nhận"}),t.jsx("input",{type:"text",id:"name",value:(e==null?void 0:e.userName)||"",readOnly:!0,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),t.jsx("br",{}),t.jsxs("div",{children:[t.jsx(j,{htmlFor:"address",value:"Địa chỉ"}),t.jsx("input",{type:"text",id:"address",value:(e==null?void 0:e.userAddress)||"",readOnly:!0,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),t.jsx("br",{}),t.jsxs("div",{children:[t.jsx(j,{htmlFor:"phone",value:"SĐT"}),t.jsx("input",{type:"text",id:"phone",value:(e==null?void 0:e.userSdt)||"",readOnly:!0,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),t.jsx("br",{}),t.jsxs("div",{children:[t.jsx(j,{htmlFor:"payment",value:"Phương thức thanh toán"}),t.jsx(E,{name:"payment",control:c,defaultValue:"",render:({field:r})=>t.jsxs(N,{id:"payment",...r,children:[t.jsx("option",{value:"",disabled:!0,children:"Chọn phương thức thanh toán"}),t.jsx("option",{value:"Cash",children:"Thanh toán khi nhận hàng"}),t.jsx("option",{value:"MoMo",children:"MoMo"}),t.jsx("option",{value:"VnPay",children:"VnPay"})]})})]}),t.jsx("br",{}),t.jsx(M,{type:"submit",className:"w-full bg-blue-700 text-white",children:"Thanh toán"})]})})]}),t.jsx("div",{className:"col-span-4",children:t.jsxs(k,{children:[t.jsx("h3",{className:"text-lg font-medium mb-4",children:"Mua sắm đấu giá"}),a?t.jsx("p",{children:"Đang tải dữ liệu đơn hàng..."}):t.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-200",children:[e!=null&&e.productImages&&e.productImages.length>0?t.jsx("img",{src:e.productImages[0],alt:e.productName||"No product name",className:"w-16 h-16 object-cover rounded-md"}):t.jsx("p",{children:"No image available"}),t.jsx("span",{children:(e==null?void 0:e.productName)||"No product name"}),t.jsx("span",{children:(e==null?void 0:e.auctionQuantity)||"0"})]}),t.jsxs("div",{className:"flex items-center justify-between py-2 font-bold",children:[t.jsx("span",{children:"Vận chuyển:"}),t.jsx("span",{children:"31,000 đ"}),t.jsx("span",{children:"Tổng cộng:"}),t.jsxs("span",{children:[b.toLocaleString()," đ"]})]})]})})]}),t.jsx(C,{})]})},H=()=>t.jsx(t.Fragment,{children:t.jsx(q,{})});export{H as default};
