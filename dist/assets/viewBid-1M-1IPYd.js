import{r as d,f as $,h as _,b5 as W,j as e,J as V,b6 as J,b7 as F,aS as Q,b8 as G,L as X,E as R,g as Y,b9 as Z}from"./index-B8WTsAS6.js";import{B as k,Q as ee}from"./react-toastify.esm-BnAFxftJ.js";/* empty css                      */import{N as te}from"./react-number-format.es-D6o-XRFQ.js";import{s as re,p as L,v as H}from"./vi-xLdnlTze.js";import{u as se}from"./index.esm-CH-ucXk-.js";import{i as q,f as O}from"./format-bLcKm-ZP.js";import{d as U}from"./differenceInMilliseconds-BlVJGjOf.js";import"./clsx-B-dksMZM.js";import"./constants-B1QkQIQl.js";const ae=({productId:r,bid:p,onClose:h})=>{const[y,x]=d.useState(!1),[m,w]=d.useState(void 0),u=$(),l=_(s=>{var c;return(c=s.auth.profile.profile)==null?void 0:c._id}),b=_(s=>s.randBid)[r]||p;d.useEffect(()=>{y&&u(W(r))},[y,r,u]);const g=()=>x(!y),B=s=>{s!==void 0?(w(s),n(s)):k.error("Lỗi xác nhận giá thầu. Làm ơn thử lại")},S=s=>w(s.floatValue),n=s=>{const c=s??m;if(!l){k.error("Bạn chưa có tài khoản. Hãy đăng nhập !!! để chỉnh sửa giá thầu");return}if(c===void 0){k.error("Giá thầu là bắt buộc");return}const N=b.minBid,a=N*1.07,j=[N,N*1.03,N*1.07];c>=N&&c<=a&&j.includes(c)&&l?u(J({productId:r,userId:l,bidAmount:c})).then(()=>{re.emitUpdateBidding(r,{userId:l,bidAmount:c}),k.success("Cập nhật giá thầu thành công!"),u(F(l)),h()}).catch(E=>{k.error(`Error: ${E.message}`)}):k.error(`Giá thầu phải lớn hơn hoặc bằng: ${j.map(E=>V.format(E,{code:"VND",symbol:""})).join(", ")}  và không vượt quá ${V.format(a,{code:"VND",symbol:""})}.`)};return e.jsxs(e.Fragment,{children:[e.jsx("button",{id:"open-modal",style:{width:150},className:`block text-white bg-gray-700 hover:bg-blue-800 \r
        focus:ring-4 focus:outline-none focus:ring-blue-300 \r
        font-medium rounded-lg text-sm px-5 py-2.5`,type:"button",onClick:g,children:"Đặt lại thầu"}),y&&e.jsx("div",{id:"default-modal",tabIndex:-1,"aria-hidden":"true",className:"fixed inset-0 flex items-center justify-center z-50 bg-transparent bg-opacity-10",children:e.jsxs("div",{className:"relative w-90 p-4 bg-white rounded-lg shadow dark:bg-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Đặt lại giá"}),e.jsxs("button",{type:"button",className:"text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white",onClick:h,children:[e.jsx("svg",{className:"w-3 h-3","aria-hidden":"true",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 14 14",children:e.jsx("path",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"})}),e.jsx("span",{className:"sr-only",children:"Close"})]})]}),e.jsxs("div",{className:"relative p-5 text-center bg-white rounded-lg shadow dark:bg-gray-800 max-w-3xl mx-auto",children:[e.jsx("div",{className:"flex justify-center items-center space-x-8",children:[{label:"Giá thấp (VND)",value:b.minBid},{label:"Giá trung bình (VND)",value:b.midBid},{label:"Giá cao (VND)",value:b.minBid*1.07}].map((s,c)=>e.jsxs("div",{className:"flex flex-col items-center w-1/3",children:[e.jsx("label",{className:"text-sm text-gray-500 dark:text-gray-300 mb-1",children:s.label}),e.jsx("button",{type:"button",className:"w-full py-3 px-6 text-sm font-medium text-center text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-900",onClick:()=>B(s.value),children:V.format(s.value??0,{code:"VND",symbol:""})})]},c))}),e.jsx("br",{}),e.jsx("hr",{className:"mb-4 border-gray-300 dark:border-gray-600"}),e.jsx("br",{}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("label",{htmlFor:"bidAmount",className:"text-sm text-gray-500 dark:text-gray-300 mb-2",children:"Giá thầu"}),e.jsx(te,{id:"bidAmount",className:"w-full py-3 px-6 text-sm font-medium text-center text-gray-900 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white",value:m,onValueChange:S,thousandSeparator:",",allowNegative:!1,decimalScale:0})]}),e.jsx("br",{}),e.jsxs("div",{className:"flex justify-center items-center space-x-8 mt-4",children:[e.jsx("button",{type:"button",className:"py-2 px-4 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-900",onClick:()=>n(),children:"Cập nhật"}),e.jsx("button",{type:"button",className:"py-2 px-4 text-sm font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-300 dark:bg-gray-500 dark:hover:bg-gray-600 dark:focus:ring-gray-700",onClick:h,children:"Đóng"})]})]})]})})]})},ie=({bidId:r,onClose:p,onDelete:h,isOpen:y})=>{const{register:x,handleSubmit:m,watch:w,formState:{errors:u}}=se(),l=$(),{services:C,loading:b}=_(n=>n.serviceRef),g=_(n=>{var s;return(s=n.auth.profile.profile)==null?void 0:s._id});d.useEffect(()=>{l(Q())},[l]);const B=w("selectedService"),S=n=>{if(!g){console.error("Đăng nhập để xóa.");return}if(!B){console.error("Please select a service.");return}const s={userId:g,biddingId:r,serviceRequestId:B,reason:n.reason,notes:n.notes};l(G(s)),l(F(g)),h(),p()};return y?e.jsx("div",{id:"default-modal",tabIndex:-1,"aria-hidden":"true",className:"fixed inset-0 flex items-center justify-center z-50 bg-transparent bg-opacity-10",children:e.jsxs("div",{className:"relative w-90 p-4 bg-white rounded-lg shadow dark:bg-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b rounded-t dark:border-gray-600",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Xóa"}),e.jsxs("button",{type:"button",className:"text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white",onClick:p,children:[e.jsx("svg",{className:"w-3 h-3","aria-hidden":"true",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 14 14",children:e.jsx("path",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"})}),e.jsx("span",{className:"sr-only",children:"Close"})]})]}),e.jsx("div",{className:"relative p-4 bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5",children:e.jsxs("form",{onSubmit:m(S),children:[e.jsx("div",{className:"grid gap-4 mb-4 sm:grid-cols-2",children:e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedService",className:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Services"}),e.jsx("select",{id:"selectedService",...x("selectedService",{required:"Chọn dịch vụ"}),className:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500",children:b?e.jsx("option",{children:"Loading..."}):C.map(n=>e.jsx("option",{value:n._id,children:n.service_name},n._id))}),u.selectedService&&e.jsx("p",{className:"text-red-500 text-sm",children:u.selectedService.message})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Lý do"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"reason-high-price",...x("reason"),value:"Giá quá cao",className:"w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600"}),e.jsx("label",{htmlFor:"reason-high-price",className:"ml-2 text-sm font-medium text-gray-900 dark:text-white",children:"Giá quá cao"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"reason-wrong-purchase",...x("reason"),value:"Mua nhầm",className:"w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600"}),e.jsx("label",{htmlFor:"reason-wrong-purchase",className:"ml-2 text-sm font-medium text-gray-900 dark:text-white",children:"Mua nhầm"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"reason-other",...x("reason"),value:"Lý do khác",className:"w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600"}),e.jsx("label",{htmlFor:"reason-other",className:"ml-2 text-sm font-medium text-gray-900 dark:text-white",children:"Lý do khác"})]})]})]}),e.jsx("br",{}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Ghi chú"}),e.jsx("textarea",{id:"notes",rows:4,...x("notes"),className:"block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"})]}),e.jsx("br",{}),e.jsx("div",{className:"flex gap-4 items-center justify-end",children:e.jsx("button",{type:"submit",className:`text-white bg-red-600 hover:bg-red-700 rounded-lg \r
                text-sm px-5 py-2.5 dark:bg-red-500 dark:hover:bg-red-600`,children:"Xóa"})})]})})]})}):null},ne=15*60*1e3,de=({bidsGroup:r,canEdit:p,openEditModal:h,openDeleteModal:y,handleCompleteAuction:x})=>{var c,N;const m=r[0].bidEndTime.endTimeBid?L(r[0].bidEndTime.endTimeBid):null,w=m?q(m):!1,u=new Date,l=w&&m?U(m,u):0,b=(a=>{if(a<=0)return"Hết thời gian";const j=Math.floor(a/(1e3*60*60)),M=Math.floor(a%(1e3*60*60)/(1e3*60)),E=Math.floor(a%(1e3*60)/1e3),A=Math.floor(j/24),T=j%24;return`${A} ngày ${T} giờ ${M} phút ${E} giây`})(l),g=(N=(c=r[0].product_bidding)==null?void 0:c.productId)==null?void 0:N._id,[B,S]=d.useState(!1),[n,s]=d.useState(!1);return d.useEffect(()=>{l<=0&&g&&!n&&b==="Hết thời gian"&&(s(!0),B||(x(g,r[0].bidEndTime._id),S(!0)))},[l,x,g,r,n,b]),e.jsxs("div",{className:`grid bg-white grid-cols-3 items-center gap-4 ${r.some(a=>a.product_bidding.productId._id===g&&a.bidEndTime.endTimeBid===r[0].bidEndTime.endTimeBid)?"border-2 border-[color:#E5E4E2] shadow-md":""}`,children:[e.jsxs("div",{className:"col-span-2 flex items-center gap-4",children:[e.jsx("div",{className:"w-15 h-24 m-4 shrink-0 border bg-white p-2 rounded-md",children:e.jsx(X,{to:`/detailAuc/${g}`,children:e.jsx("img",{src:r[0].product_bidding.productId.image[0],className:"w-full h-full object-contain",alt:r[0].product_bidding.productId.product_name})})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-gray-800 font-bold text-xl",children:r[0].product_bidding.productId.product_name}),e.jsxs("p",{className:"text-gray-600",children:["Thời gian hiện tại:"," ",O(u,"HH:mm:ss, 'ngày' EEEE, d MMMM 'năm' yyyy ",{locale:H})]}),e.jsxs("p",{className:"text-gray-600",children:["Thời gian kết thúc:"," ",w&&m?O(m,"HH:mm:ss,  'ngày' EEEE, d MMMM 'năm' yyyy",{locale:H}):"Không xác định"]}),e.jsxs("p",{className:"text-gray-800",children:["Thời gian còn lại: ",b]})]})]}),e.jsx("div",{className:"flex flex-col gap-2",children:r.map(a=>{var T;const j=(T=a.bidEndTime)!=null&&T.endTimeBid?L(a.bidEndTime.endTimeBid):null,A=((j?q(j):!1)&&j?U(j,u):0)<ne;return e.jsxs("div",{className:"bg-white p-3 m-1 rounded-md border border-[color:#DAA520] shadow-lg",children:[e.jsx("p",{className:"font-bold text-gray-700",children:"Thông tin đấu giá"}),e.jsxs("p",{className:"text-gray-600",children:["Ngày đấu giá:"," ",O(L(a.createdAt),"d/M/yy HH:mm:ss",{locale:H})]}),e.jsxs("p",{className:"text-gray-600",children:["Giá đấu: ",a.bidAmount.toLocaleString()," đ"]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[p[a._id]&&e.jsx(R,{color:"light",onClick:()=>h(a),disabled:A,children:"Sửa"}),e.jsx(R,{color:"red",onClick:()=>y(a),disabled:A,children:"Xóa"})]})]},a._id)})})]},r[0]._id)},oe=()=>{var P;const r=$(),p=_(t=>{var i;return(i=t.auth.profile.profile)==null?void 0:i._id}),h=_(t=>t.bidding.bids)||[],[y,x]=d.useState(null),[m,w]=d.useState({}),[u,l]=d.useState(new Date),[C,b]=d.useState(!1),[g,B]=d.useState(null),[S,n]=d.useState({}),[s,c]=d.useState(new Set),N=Y();d.useEffect(()=>{const t=setInterval(()=>{l(new Date)},1e3);return()=>clearInterval(t)},[]),d.useEffect(()=>{p&&r(F(p))},[p,r]),d.useEffect(()=>{(()=>{const i={...m};h.forEach(o=>{const f=o.bidEndTime.endTimeBid?L(o.bidEndTime.endTimeBid):null;f?i[o._id]=f.getTime()-u.getTime()>9e5:i[o._id]=!1}),w(i)})()},[h,u]),d.useEffect(()=>{(()=>{const i={};h.forEach(f=>{var I,D;const v=(D=(I=f.product_bidding)==null?void 0:I.productId)==null?void 0:D.product_name;v&&(i[v]||(i[v]={totalBids:0,totalAmount:0}),i[v].totalBids+=1,i[v].totalAmount+=f.bidAmount)});const o=Object.keys(i).reduce((f,v)=>{const{totalBids:I,totalAmount:D}=i[v],K=D/I;return f[v]={averageBid:K,totalBids:I,totalPayment:D},f},{});n(o)})()},[h]);const a=t=>{x(t)},j=t=>{B(t),b(!0)},M=()=>{b(!1),B(null)},E=()=>{M(),r(F(p))},T=(()=>{const t={};return h.forEach(i=>{var f,v;const o=(v=(f=i.product_bidding)==null?void 0:f.productId)==null?void 0:v._id;o&&(t[o]||(t[o]=[]),t[o].push(i))}),Object.values(t)})(),z=async(t,i)=>{if(!t){k.error("Đấu giá bị lỗi");return}if(!s.has(t)){if(!p){k.error("Bạn chưa có tài khoản");return}try{await r(Z({productId:t,timeTrackID:i})),k.success("Hoàn thành đấu giá",{onClose:()=>{c(o=>new Set(o).add(t)),N("/checkoutAuc")}})}catch(o){k.error("Failed to complete auction"),console.error("Complete auction error:",o)}}};return e.jsxs("div",{className:"container mx-auto px-4 lg:px-8 py-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs("div",{className:"border border-gray-200 p-4 rounded-lg shadow-sm bg-white mb-16",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Lượt đấu giá"}),e.jsx(X,{to:"/profile",className:"bg-indigo-500 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition duration-200",children:"Lịch sử lệnh đấu giá"})]}),e.jsx("hr",{className:"border-gray-300 mt-4 mb-8"}),e.jsx("div",{className:"space-y-8",children:T.length>0?T.map(t=>e.jsx(de,{bidsGroup:t,canEdit:m,openEditModal:a,openDeleteModal:j,handleCompleteAuction:z},t[0]._id)):e.jsx("p",{className:"text-gray-600",children:"Không có lượt đấu giá nào."})})]})}),e.jsxs("div",{className:"md:col-span-1 bg-white border border-gray-500 p-4 rounded-lg shadow-sm",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Sổ lệnh"}),Object.entries(S).map(([t,{averageBid:i,totalBids:o,totalPayment:f}])=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-md font-medium text-gray-700",children:["Sản phẩm: ",t]}),e.jsxs("p",{className:"text-gray-600",children:["Trung bình giá đấu: ",Math.floor(i).toLocaleString()," đ"]}),e.jsxs("p",{className:"text-gray-600",children:["Tổng số lượt đấu giá: ",o]}),e.jsxs("p",{className:"text-gray-600",children:["Tổng thanh toán: ",f.toLocaleString()," đ"]})]},t))]})]}),y&&e.jsx(ae,{productId:(P=y.product_bidding)==null?void 0:P.productId._id,bid:y,onClose:()=>x(null)}),g&&e.jsx(ie,{bidId:g._id,onClose:M,onDelete:E,isOpen:C}),e.jsx(ee,{})]})},ye=()=>e.jsx(e.Fragment,{children:e.jsx(oe,{})});export{ye as default};
